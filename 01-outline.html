<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><link href="css/default.css" rel="stylesheet" type="text/css" /><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>Conceptual Overview</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Wheel</span> <span class="project-version">0.1.21</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1  current"><a href="01-outline.html"><div class="inner"><span>Conceptual Overview</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>rill</span></div></div></li><li class="depth-2"><a href="rill.wheel.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wheel</span></div></a></li><li class="depth-3 branch"><a href="rill.wheel.bare-repository.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bare-repository</span></div></a></li><li class="depth-3 branch"><a href="rill.wheel.caching-repository.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching-repository</span></div></a></li><li class="depth-3 branch"><a href="rill.wheel.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-3 branch"><a href="rill.wheel.repository.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repository</span></div></a></li><li class="depth-3 branch"><a href="rill.wheel.testing.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>testing</span></div></a></li><li class="depth-3 branch"><a href="rill.wheel.trigger.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>trigger</span></div></a></li><li class="depth-3 branch"><a href="rill.wheel.wrap-new-events-callback.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wrap-new-events-callback</span></div></a></li><li class="depth-3 branch"><a href="rill.wheel.wrap-stream-properties.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wrap-stream-properties</span></div></a></li><li class="depth-3"><a href="rill.wheel.wrap-upcasts.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wrap-upcasts</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#conceptual-overview" name="conceptual-overview"></a>Conceptual Overview</h1>
<p>Welcome to the manual of <code>Wheel</code>, a library for building Event Sourcing systems.</p>
<p>This manual is intended for people who want to build an Event Sourcing system and need to get a good overview of what <code>Wheel</code> provides.</p>
<p>Since Event Sourcing may not be a familiar architecture, and because some of the design choices that <code>Wheel</code> makes may be different from whatâ€™s expected coming from other Event Sourcing libraries, we want to describe the concepts in very general terms first, so that readers will get a reasonable understanding of the mechanisms and trade-offs involved.</p>
<p>See also <a href="design-and-implementation/presentation.pdf">the design-and-implementation presentation</a>.</p>
<h2><a href="#command-query-responsibility-separation" name="command-query-responsibility-separation"></a>Command/Query responsibility separation</h2>
<p>Rill/Wheel is built assuming a <a href="http://martinfowler.com/bliki/CQRS.html">CQRS-style</a> separation between the Query (read) side and Command (write) side of an application, where state updates on the query side are completely determined by events from the Event Store, and the command side is responsible for generating new events.</p>
<p><img src="cqrs.svg" alt="CQRS" /></p>
<p>The <code>Wheel</code> library contains tools for implementing the Command side of a CQRS system using Event Sourcing. <code>Wheel</code> builds on top of <code>Rill</code>, where <code>Rill</code> provides protocols and implementations of Event Stores and messages.</p>
<h2><a href="#storing-state-as-events-streams-and-consistency" name="storing-state-as-events-streams-and-consistency"></a>Storing state as events: streams and consistency</h2>
<p>In an Event Sourcing system, the source of truth is the append-only log of domain events, as committed in the Event Store. Events are messages that describe things that happened in the domain. In an Event Store, events are committed to a particular stream, which is similar to a <em>topic</em> in other message-based systems.</p>
<p>Consistency is provided by serializing commits to a stream; every event stream has a version, which is incremented every time events are committed to the stream. When a new set of events is committed to the stream, an expected version number can be provided, ensuring that the commit will only be accepted if the stream has not changed (i.e. no events were added to the stream since the new events were prepared).</p>
<pre><code>Execute command:
  Prepare state:
    Fetch Events from Stream
    Apply Events to State, setting StateVersion
  Generate NewEvents based on State or return {Rejection}
  Commit NewEvents to Stream when StreamVersion == StateVersion ; atomic
  Return {Ok, Events} or {Conflict}
</code></pre>
<p><em>Pseudocode describing consistency mechanism. Note that the Commit  with version check is an atomic operation</em></p>
<h2><a href="#generating-events-commands-and-aggregates" name="generating-events-commands-and-aggregates"></a>Generating events: commands and aggregates</h2>
<p>In <code>Wheel</code>, state changes (new events) are generated by commands via aggregates. Aggregates are reductions of an event stream that describe the state of an event stream that is necessary to generate new events.</p>
<p>An aggregate is an entity with an identity mapped to the stream identifier, some state generated by applying the events in the stream to the aggregate, and a version number which is the number of events committed.</p>
<p><img src="commands.svg" alt="Commands" /></p>
<p>Commands are functions that take an aggregate and apply new events to it. The process is described in detail in <a href="rill.wheel.html">rill.wheel</a>.</p></div></div></div></body></html>